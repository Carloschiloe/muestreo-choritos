<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Resumen de Resultados</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
        }

        .container {
            max-width: 100%;
            margin: auto;
            padding: 0;
        }

        .summary-table {
            width: 100%;
            table-layout: fixed;
            word-wrap: break-word;
            margin-top: 20px;
        }

        .summary-table th,
        .summary-table td {
            text-align: center;
            vertical-align: middle;
            padding: 10px;
            font-size: 14px;
            word-wrap: break-word;
        }

        .summary-table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 2;
        }

        .thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }

        .edit-btn,
        .delete-btn {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .summary-table th,
            .summary-table td {
                font-size: 12px;
                padding: 5px;
            }

            .thumbnail {
                width: 30px;
                height: 30px;
            }
        }

        @media (max-width: 576px) {
            .summary-table th,
            .summary-table td {
                font-size: 10px;
                padding: 4px;
            }

            .thumbnail {
                width: 25px;
                height: 25px;
            }
        }

        .filter-dropdown {
            padding: 5px;
            font-size: 12px;
            width: 100%;
        }

        .column-toggle {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
        }

        .column-toggle label {
            margin-right: 10px;
        }

        .column-header-checkbox {
            float: left;
            margin-right: 5px;
        }

        .filter-row {
            display: table-row;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center">Resumen de Resultados</h1>

        <!-- Checkboxes para mostrar las columnas ocultas -->
        <div class="column-toggle" id="columnToggle">
            <!-- Las columnas ocultas aparecerán aquí -->
        </div>

        <table class="table table-bordered summary-table" id="dataTable">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="0">
                        Fecha
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="1">
                        Hora
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="2">
                        Temp (°C)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="3">
                        Centro Cultivo
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="4">
                        N° Línea
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="5">
                        Plataforma
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="6">
                        Rotos (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="7">
                        Trizados (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="8">
                        Cholgas (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="9">
                        Malton (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="10">
                        Picorocos (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="11">
                        Otros (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="12">
                        Choritos (%)
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="13">
                        Observaciones
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="14">
                        Responsable
                    </th>
                    <th>
                        <input type="checkbox" class="column-header-checkbox" data-column="15">
                        Foto
                    </th>
                    <th>Acciones</th>
                </tr>
                <!-- Fila de Filtros -->
                <tr class="filter-row">
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(0)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(1)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(2)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(3)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(4)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(5)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(6)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(7)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(8)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(9)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(10)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(11)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(12)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(13)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-dropdown" onchange="filterColumn(14)">
                            <option value="">Todos</option>
                        </select>
                    </td>
                    <td></td>
                    <td></td>
                </tr>
            </thead>
            <tbody id="summaryTableBody">
                <!-- Filas agregadas dinámicamente -->
            </tbody>
        </table>
    </div>

    <script>
        let storedSamples = JSON.parse(localStorage.getItem('storedSamples')) || [];
        const tbody = document.getElementById('summaryTableBody');
        const columnToggles = document.querySelectorAll('.column-header-checkbox');
        const hiddenColumnsToggle = document.getElementById('columnToggle');

        // Mostrar/ocultar columnas
        function toggleColumnVisibility(columnIndex, show) {
            const table = document.getElementById('dataTable');
            const rows = table.rows;

            for (let i = 0; i < rows.length; i++) {
                const cell = rows[i].cells[columnIndex];
                if (cell) {
                    cell.style.display = show ? '' : 'none';
                }
            }
        }

        // Añadir opción para mostrar las columnas ocultas
        function addHiddenColumnToggle(columnIndex) {
            const label = document.createElement('label');
            const columnTitle = getColumnTitle(columnIndex);
            label.innerHTML = `<input type="checkbox" class="toggle-column" data-column="${columnIndex}"> Mostrar ${columnTitle}`;
            hiddenColumnsToggle.appendChild(label);

            const checkbox = label.querySelector('input');
            checkbox.addEventListener('change', function () {
                if (this.checked) {
                    toggleColumnVisibility(columnIndex, true);
                    hiddenColumnsToggle.removeChild(label);
                    columnToggles[columnIndex].checked = false;
                }
            });
        }

        // Obtener título de columna
        function getColumnTitle(columnIndex) {
            const headers = document.querySelectorAll('.summary-table th');
            return headers[columnIndex].textContent.trim();
        }

        // Manejar el evento de ocultar/mostrar columnas
        columnToggles.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const columnIndex = parseInt(this.dataset.column);
                if (this.checked) {
                    toggleColumnVisibility(columnIndex, false);
                    addHiddenColumnToggle(columnIndex);
                } else {
                    toggleColumnVisibility(columnIndex, true);
                }
            });
        });

        // Población de filtros
        function populateFilters() {
            const columnsData = Array.from({ length: 15 }, () => new Set());

            storedSamples.forEach(sample => {
                columnsData[0].add(sample.fecha);
                columnsData[1].add(sample.hora);
                columnsData[2].add(sample.temperatura);
                columnsData[3].add(sample.centro);
                columnsData[4].add(sample.linea);
                columnsData[5].add(sample.plataforma);
                columnsData[6].add(((parseFloat(sample.rotos) / parseFloat(sample.total)) * 100).toFixed(2));
                columnsData[7].add(((parseFloat(sample.trizados) / parseFloat(sample.total)) * 100).toFixed(2));
                columnsData[8].add(((parseFloat(sample.cholgas) / parseFloat(sample.total)) * 100).toFixed(2));
                columnsData[9].add(((parseFloat(sample.malton) / parseFloat(sample.total)) * 100).toFixed(2));
                columnsData[10].add(((parseFloat(sample.picorocos) / parseFloat(sample.total)) * 100).toFixed(2));
                columnsData[11].add(((parseFloat(sample.otros) / parseFloat(sample.total)) * 100).toFixed(2));
                columnsData[12].add(((parseFloat(sample.total) - (parseFloat(sample.rotos) + parseFloat(sample.trizados) + parseFloat(sample.cholgas) + parseFloat(sample.malton) + parseFloat(sample.picorocos) + parseFloat(sample.otros))) / parseFloat(sample.total) * 100).toFixed(2));
                columnsData[13].add(sample.observaciones);
                columnsData[14].add(sample.responsable);
            });

            document.querySelectorAll('.filter-dropdown').forEach((dropdown, index) => {
                const options = Array.from(columnsData[index]).sort();
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    dropdown.appendChild(optionElement);
                });
            });
        }

        // Filtrado de columnas
        function filterColumn(columnIndex) {
            const selectedValue = document.querySelectorAll('.filter-dropdown')[columnIndex].value;
            const filteredSamples = selectedValue === "" ? storedSamples : storedSamples.filter(sample => {
                switch (columnIndex) {
                    case 0: return sample.fecha === selectedValue;
                    case 1: return sample.hora === selectedValue;
                    case 2: return sample.temperatura === selectedValue;
                    case 3: return sample.centro === selectedValue;
                    case 4: return sample.linea === selectedValue;
                    case 5: return sample.plataforma === selectedValue;
                    case 6: return ((parseFloat(sample.rotos) / parseFloat(sample.total)) * 100).toFixed(2) === selectedValue;
                    case 7: return ((parseFloat(sample.trizados) / parseFloat(sample.total)) * 100).toFixed(2) === selectedValue;
                    case 8: return ((parseFloat(sample.cholgas) / parseFloat(sample.total)) * 100).toFixed(2) === selectedValue;
                    case 9: return ((parseFloat(sample.malton) / parseFloat(sample.total)) * 100).toFixed(2) === selectedValue;
                    case 10: return ((parseFloat(sample.picorocos) / parseFloat(sample.total)) * 100).toFixed(2) === selectedValue;
                    case 11: return ((parseFloat(sample.otros) / parseFloat(sample.total)) * 100).toFixed(2) === selectedValue;
                    case 12: return ((parseFloat(sample.total) - (parseFloat(sample.rotos) + parseFloat(sample.trizados) + parseFloat(sample.cholgas) + parseFloat(sample.malton) + parseFloat(sample.picorocos) + parseFloat(sample.otros))) / parseFloat(sample.total) * 100).toFixed(2) === selectedValue;
                    case 13: return sample.observaciones === selectedValue;
                    case 14: return sample.responsable === selectedValue;
                }
            });
            displaySamples(filteredSamples);
        }

        // Mostrar las filas filtradas
        function displaySamples(samples = storedSamples) {
            tbody.innerHTML = '';
            samples.slice().reverse().forEach((sample, index) => {
                const row = document.createElement('tr');
                const total = parseFloat(sample.total) || 0;
                const rotos = parseFloat(sample.rotos) || 0;
                const trizados = parseFloat(sample.trizados) || 0;
                const cholgas = parseFloat(sample.cholgas) || 0;
                const malton = parseFloat(sample.malton) || 0;
                const picorocos = parseFloat(sample.picorocos) || 0;
                const otros = parseFloat(sample.otros) || 0;
                const choritos = total - (rotos + trizados + cholgas + malton + picorocos + otros);

                const fotoUrl = typeof sample.foto === 'string' ? sample.foto : "";
                const fotoHtml = fotoUrl ? `<a href="${fotoUrl}" target="_blank"><img src="${fotoUrl}" class="thumbnail" alt="Foto"></a>` : "No disponible";

                row.innerHTML = `
                    <td>${sample.fecha}</td>
                    <td>${sample.hora}</td>
                    <td>${sample.temperatura}</td>
                    <td>${sample.centro}</td>
                    <td>${sample.linea}</td>
                    <td>${sample.plataforma}</td>
                    <td>${(rotos / total * 100).toFixed(2)}</td>
                    <td>${(trizados / total * 100).toFixed(2)}</td>
                    <td>${(cholgas / total * 100).toFixed(2)}</td>
                    <td>${(malton / total * 100).toFixed(2)}</td>
                    <td>${(picorocos / total * 100).toFixed(2)}</td>
                    <td>${(otros / total * 100).toFixed(2)}</td>
                    <td>${(choritos / total * 100).toFixed(2)}</td>
                    <td>${sample.observaciones || ""}</td>
                    <td>${sample.responsable}</td>
                    <td>${fotoHtml}</td>
                    <td>
                        <span class="edit-btn" onclick="loadSampleToForm(${storedSamples.length - 1 - index})">✏️</span> |
                        <span class="delete-btn" onclick="deleteRow(${storedSamples.length - 1 - index})">❌</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSampleToForm(index) {
            const sample = storedSamples[index];
            localStorage.setItem('editIndex', index);
            localStorage.setItem('editingSample', JSON.stringify(sample));
            window.location.href = 'formulario.html';
        }

        function deleteRow(index) {
            if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
                storedSamples.splice(index, 1);
                localStorage.setItem('storedSamples', JSON.stringify(storedSamples));
                displaySamples();
            }
        }

        populateFilters();
        displaySamples();
    </script>
</body>

</html>
